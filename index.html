<!DOCTYPE html>
<html>
<head>
<style> 

	body,
	html {
	  margin: 0px;
	  padding: 0px;
	  width: 100%;
	  display: flex;
	  flex-direction: column;
	}
	#main {
	  background-color: rgb(190, 190, 190);
	  width: 100%;
	  height: 100%;  
	  
	}

	.chart_area2 {
	  background-color: rgb(50, 50, 100);
	  width: auto;
	  height: 500px;
	  margin: 60px 20px;
	  padding: 0px;
	  display: flex;
	  flex-direction: column;
	}

	.tbl {
	  width: auto;
	  height: 500px;
	  margin: 60px 20px;
	  padding: 0px;
	  display: flex;
	  flex-direction: column;
	}
</style>
</head>


<body>
<title>Мониторинг ДНГ</title>
<div id="main">
  </div>
   <div class="chart_area2" id="area10">
  </div>
  
  
  </div>
    <table class="tbl" id="my_table">
	  <tr>
		<td width="150px></td>
		<th scope="col">Дата Время</th>
		<th scope="col">Стандартный объем,м3</th>
	  </tr>
    </table>
  </div>
   
</div>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js" type="text/javascript"></script>
<script src="plotly-latest.min.js"></script>
<script  type="text/javascript">

document.addEventListener('DOMContentLoaded', load_data(), false);

function makeTable(array) {
    var table = document.getElementById('my_table');
    for (var i = 0; i < array.length; i++) {
        var row = document.createElement('tr');

            var tm = document.createElement('td');
            tm.textContent = new Date(array[i].t_stamp*1000).toLocaleString();
			row.appendChild(tm);
			tm.style.width= "180px";
            var p = document.createElement('td');
            p.textContent = array[i].p_1;
            row.appendChild(p);

        table.appendChild(row);
    }
    return table;
}

function load_data()
{    
	var skey="/1Ah_Rt_mB_cg+k/0_8w_LC_YC8l+8P_ab_JC_vd2_Irz_5Z_yj"
					       
	AWS.config.update({
		region: 'eu-west-2',
		endpoint: 'https://dynamodb.eu-west-2.amazonaws.com',
		accessKeyId: 'AKIAVLPJFTNLMAPB455Z',
		secretAccessKey: skey.replace(/_//g, "");	
	});
        
	var docClient = new AWS.DynamoDB.DocumentClient();
	var start_ts=Math.floor(Date.now() / 1000)-12000;
	var inc=1;
	
	docClient.query({   TableName: "dng7",	KeyConditionExpression: "m_key = :m_key and t_stamp>=:ts",	ProjectionExpression: "t_stamp, p_1",	ExpressionAttributeValues: { ":m_key": "ALLIANCE",":ts":start_ts},	ReturnConsumedCapacity:  "TOTAL"	}, get_alliance);	
	
	function get_alliance(err, data) {render_alliance(data,"area10","Кирпичный завод Брикс")};  
	


	function render_alliance(data, chart_name, m_title)
	{
		data=data.Items
		
		var xv=[], v=[];
		for (var i=0; i< data.length;i+=inc)
		{
			xv.push(timeConverter(data[i].t_stamp));
			v.push(data[i].p_1);
		}
		
		
		var plot_data=[
		
			{x:xv,y:v, name: '___V, м3___',fillcolor: 'rgba(50, 50, 50,0.5)', line: { color: 'rgb(150, 150, 50)'}}

		];		
				
		var layout = {
		  title: m_title,
		  responsive: true,
		  autorange: true,
		  showlegend: true,
		  mode: 'lines+markers'
		};
				
		Plotly.newPlot(chart_name,plot_data,layout, {responsive: true}); 	
		console.log(data);
		makeTable(data);
	}
	
	
	
	
}

function timeConverter(UNIX_timestamp){
    var date = new Date(UNIX_timestamp * 1000);
	var hours = date.getHours();
	var minutes = "0" + date.getMinutes();
	var seconds = "0" + date.getSeconds();
	var formattedTime = hours + '-' + minutes.substr(-2) + '-' + seconds.substr(-2);
    return date;
}

function timeConverter2(UNIX_timestamp){
    var date = new Date(UNIX_timestamp * 1000);
	var hours = date.getHours();
	var minutes = "0" + date.getMinutes();
	var seconds = "0" + date.getSeconds();
	var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
    return formattedTime;
}


</script>
</body>
</html>
